-- ============================================
-- СОЗДАНИЕ ТАБЛИЦ
-- ============================================

-- 1. НАПРАВЛЕНИЯ ПОДГОТОВКИ (STUDY_PROGRAMS)
CREATE TABLE study_programs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    level VARCHAR(50) NOT NULL,
    start_year INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. ГРУППЫ СТУДЕНТОВ (STUDENT_GROUPS)
CREATE TABLE student_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    program_id INTEGER NOT NULL REFERENCES study_programs(id),
    group_code VARCHAR(10) NOT NULL UNIQUE,
    curator VARCHAR(100),
    created_at DATE DEFAULT CURRENT_DATE
);

-- 3. СТУДЕНТЫ (STUDENTS)
CREATE TABLE students (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_code VARCHAR(50) UNIQUE,
    last_name VARCHAR(100) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    patronymic VARCHAR(100),
    birth_date DATE NOT NULL,
    gender CHAR(1) NOT NULL CHECK (gender IN ('M', 'F')),
    enrollment_year INTEGER NOT NULL CHECK (enrollment_year >= 2000),
    status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'GRADUATED', 'EXPIRED')),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 4. ДИСЦИПЛИНЫ (SUBJECTS)
CREATE TABLE subjects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    credits INTEGER DEFAULT 3
);

-- 5. ЭКЗАМЕНЫ (EXAMS)
CREATE TABLE exams (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    subject_id INTEGER NOT NULL REFERENCES subjects(id),
    group_id INTEGER NOT NULL REFERENCES student_groups(id),
    teacher_name VARCHAR(100),
    exam_date DATE NOT NULL,
    academic_year VARCHAR(9) NOT NULL,
    semester INTEGER NOT NULL CHECK (semester IN (1, 2)),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 6. РЕЗУЛЬТАТЫ ЭКЗАМЕНОВ (EXAM_RESULTS)
CREATE TABLE exam_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    exam_id INTEGER NOT NULL REFERENCES exams(id),
    student_id INTEGER NOT NULL REFERENCES students(id),
    grade INTEGER NOT NULL CHECK (grade BETWEEN 2 AND 5),
    passed_at DATE DEFAULT CURRENT_DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 7. ЗАЧЁТЫ (TESTS)
CREATE TABLE tests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL REFERENCES students(id),
    subject_id INTEGER NOT NULL REFERENCES subjects(id),
    academic_year VARCHAR(9) NOT NULL,
    semester INTEGER NOT NULL CHECK (semester IN (1, 2)),
    is_passed BOOLEAN DEFAULT FALSE,
    passed_at DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 8. ИСТОРИЯ ГРУПП (GROUP_HISTORY)
CREATE TABLE group_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL REFERENCES students(id),
    group_id INTEGER NOT NULL REFERENCES student_groups(id),
    academic_year VARCHAR(9) NOT NULL,
    semester INTEGER NOT NULL CHECK (semester IN (1, 2)),
    course INTEGER NOT NULL CHECK (course BETWEEN 1 AND 6),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- ИНДЕКСЫ
-- ============================================

CREATE INDEX idx_students_name ON students(last_name, first_name);
CREATE INDEX idx_students_code ON students(student_code);
CREATE INDEX idx_group_history_student ON group_history(student_id);
CREATE INDEX idx_group_history_group ON group_history(group_id);
CREATE INDEX idx_exam_results_student ON exam_results(student_id);
CREATE INDEX idx_exam_results_grade ON exam_results(grade);
CREATE INDEX idx_tests_student ON tests(student_id);
CREATE INDEX idx_exams_group ON exams(group_id);
CREATE INDEX idx_exams_subject ON exams(subject_id);


CREATE UNIQUE INDEX uniq_group_history_student_semester
ON group_history(student_id, academic_year, semester);

CREATE UNIQUE INDEX uniq_exam_results_exam_student
ON exam_results(exam_id, student_id);

CREATE UNIQUE INDEX uniq_exams_group_subject
ON exams(subject_id, group_id, academic_year, semester);

-- ============================================
-- ВСТАВКА ТЕСТОВЫХ ДАННЫХ
-- ============================================

-- 1. НАПРАВЛЕНИЯ ПОДГОТОВКИ
INSERT INTO study_programs (code, name, level, start_year) VALUES
('02.03.01', 'Фундаментальная информатика и информационные технологии', 'Бакалавриат', 2020),
('02.03.02', 'Фундаментальная информатика и ИТ (англ. язык)', 'Бакалавриат', 2020),
('01.03.02', 'Прикладная математика и информатика', 'Бакалавриат', 2020),
('09.03.04', 'Программная инженерия', 'Бакалавриат', 2020),
('09.03.05', 'Программная инженерия (бизнес-информатика)', 'Бакалавриат', 2020),
('02.04.01', 'Фундаментальная информатика и информационные технологии', 'Магистратура', 2022),
('01.04.02', 'Прикладная математика и информатика', 'Магистратура', 2022),
('09.04.04', 'Программная инженерия', 'Магистратура', 2022);

-- 2. ГРУППЫ
INSERT INTO student_groups (program_id, group_code, curator, created_at) VALUES
-- 1 курс бакалавриат (2023/2024)
(1, '101', 'Иванов Иван Иванович', '2023-09-01'),
(2, '102', 'Петров Петр Петрович', '2023-09-01'),
(3, '103', 'Сидоров Алексей Дмитриевич', '2023-09-01'),
(4, '104', 'Кузнецова Анна Андреевна', '2023-09-01'),
(5, '105', 'Морозов Дмитрий Викторович', '2023-09-01'),

-- 2 курс бакалавриат (2022/2023)
(1, '201', 'Смирнова Ольга Владимировна', '2022-09-01'),
(2, '202', 'Васильев Михаил Сергеевич', '2022-09-01'),
(3, '203', 'Федорова Екатерина Игоревна', '2022-09-01'),
(4, '204', 'Николаев Сергей Александрович', '2022-09-01'),
(5, '205', 'Павлова Мария Петровна', '2022-09-01'),

-- 3 курс бакалавриат (2021/2022)
(1, '301', 'Алексеев Андрей Николаевич', '2021-09-01'),
(2, '302', 'Григорьева Татьяна Викторовна', '2021-09-01'),
(3, '303', 'Дмитриев Павел Олегович', '2021-09-01'),
(4, '304', 'Орлова Надежда Борисовна', '2021-09-01'),
(5, '305', 'Тихонов Илья Константинович', '2021-09-01'),

-- 4 курс бакалавриат (2020/2021)
(1, '401', 'Захарова Людмила Георгиевна', '2020-09-01'),
(2, '402', 'Романов Артем Владимирович', '2020-09-01'),
(3, '403', 'Киселева Вероника Анатольевна', '2020-09-01'),
(4, '404', 'Белов Станислав Игоревич', '2020-09-01'),
(5, '405', 'Медведева Алина Сергеевна', '2020-09-01'),

-- 1 курс магистратура (2023/2024)
(6, '501', 'Фролов Константин Павлович', '2023-09-01'),
(7, '502', 'Жукова Ирина Васильевна', '2023-09-01'),
(8, '503', 'Савельев Николай Дмитриевич', '2023-09-01'),

-- 2 курс магистратура (2022/2023)
(6, '601', 'Тарасов Виктор Андреевич', '2022-09-01'),
(7, '602', 'Воробьева Светлана Михайловна', '2022-09-01'),
(8, '603', 'Гусев Артур Эдуардович', '2022-09-01');

-- 3. СТУДЕНТЫ
INSERT INTO students (student_code, last_name, first_name, patronymic, birth_date, gender, enrollment_year, status) VALUES
-- Группа 101 (1 курс, направление 1)
('23101-001', 'Иванов', 'Александр', 'Сергеевич', '2004-05-15', 'M', 2023, 'ACTIVE'),
('23101-002', 'Петрова', 'Мария', 'Андреевна', '2004-08-22', 'F', 2023, 'ACTIVE'),
('23101-003', 'Сидоров', 'Максим', 'Дмитриевич', '2004-03-10', 'M', 2023, 'ACTIVE'),
('23101-004', 'Козлова', 'Анна', 'Викторовна', '2004-11-30', 'F', 2023, 'ACTIVE'),
('23101-005', 'Морозов', 'Артем', 'Игоревич', '2004-01-25', 'M', 2023, 'ACTIVE'),

-- Группа 103 (1 курс, направление 3)
('23103-001', 'Николаев', 'Денис', 'Павлович', '2004-07-14', 'M', 2023, 'ACTIVE'),
('23103-002', 'Волкова', 'Екатерина', 'Сергеевна', '2004-09-05', 'F', 2023, 'ACTIVE'),
('23103-003', 'Федоров', 'Илья', 'Александрович', '2004-12-18', 'M', 2023, 'ACTIVE'),
('23103-004', 'Смирнова', 'Ольга', 'Ивановна', '2004-04-20', 'F', 2023, 'ACTIVE'),
('23103-005', 'Алексеев', 'Сергей', 'Владимирович', '2004-06-11', 'M', 2023, 'ACTIVE'),

-- Группа 105 (1 курс, направление 5)
('23105-001', 'Павлов', 'Роман', 'Николаевич', '2004-10-05', 'M', 2023, 'ACTIVE'),
('23105-002', 'Зайцева', 'Наталья', 'Александровна', '2004-02-28', 'F', 2023, 'ACTIVE'),
('23105-003', 'Соколов', 'Владимир', 'Петрович', '2004-07-30', 'M', 2023, 'ACTIVE'),

-- Группа 203 (2 курс, направление 3)
('22203-001', 'Борисов', 'Андрей', 'Михайлович', '2003-05-12', 'M', 2022, 'ACTIVE'),
('22203-002', 'Киселева', 'Елена', 'Анатольевна', '2003-08-19', 'F', 2022, 'ACTIVE'),
('22203-003', 'Григорьев', 'Павел', 'Олегович', '2003-03-25', 'M', 2022, 'ACTIVE'),
('22203-004', 'Титова', 'Виктория', 'Игоревна', '2003-11-08', 'F', 2022, 'ACTIVE'),
('22203-005', 'Макаров', 'Дмитрий', 'Викторович', '2003-01-30', 'M', 2022, 'ACTIVE'),

-- Группа 303 (3 курс, направление 3)
('21303-001', 'Орлов', 'Константин', 'Борисович', '2002-06-14', 'M', 2021, 'ACTIVE'),
('21303-002', 'Романова', 'Алиса', 'Владимировна', '2002-09-22', 'F', 2021, 'ACTIVE'),
('21303-003', 'Васнецов', 'Игорь', 'Сергеевич', '2002-04-17', 'M', 2021, 'ACTIVE'),
('21303-004', 'Лебедева', 'Марина', 'Андреевна', '2002-12-03', 'F', 2021, 'ACTIVE'),
('21303-005', 'Герасимов', 'Никита', 'Денисович', '2002-02-11', 'M', 2021, 'ACTIVE'),

-- Группа 403 (4 курс, направление 3)
('20403-001', 'Жуков', 'Вадим', 'Александрович', '2001-07-08', 'M', 2020, 'ACTIVE'),
('20403-002', 'Фомина', 'Дарья', 'Павловна', '2001-10-15', 'F', 2020, 'ACTIVE'),
('20403-003', 'Давыдов', 'Арсений', 'Игоревич', '2001-05-23', 'M', 2020, 'ACTIVE'),
('20403-004', 'Семенова', 'Кристина', 'Витальевна', '2001-03-19', 'F', 2020, 'ACTIVE'),
('20403-005', 'Крылов', 'Тимофей', 'Аркадьевич', '2001-01-14', 'M', 2020, 'ACTIVE');

-- 4. ДИСЦИПЛИНЫ
INSERT INTO subjects (code, name, credits) VALUES
('МАТ-101', 'Математический анализ', 6),
('МАТ-102', 'Алгебра и геометрия', 5),
('МАТ-103', 'Дискретная математика', 4),
('ФИЗ-101', 'Физика', 4),
('ИНФ-101', 'Основы программирования', 6),
('ИНФ-102', 'Объектно-ориентированное программирование', 5),
('ИНФ-201', 'Структуры данных и алгоритмы', 5),
('ИНФ-202', 'Базы данных', 4),
('ИНФ-203', 'Операционные системы', 4),
('ИНФ-204', 'Компьютерные сети', 4),
('ИНФ-205', 'Теория вероятностей и математическая статистика', 4),
('ИНФ-206', 'Функциональное программирование', 3),
('ПМИ-301', 'Численные методы', 4),
('ПМИ-302', 'Математическое моделирование', 4),
('ПМИ-303', 'Методы оптимизации', 4),
('ПМИ-304', 'Искусственный интеллект', 5),
('ПМИ-305', 'Машинное обучение', 5),
('ГУМ-101', 'История', 2),
('ГУМ-102', 'Философия', 2),
('ГУМ-103', 'Иностранный язык', 3),
('ФИЗ-КУ', 'Физическая культура', 2);

-- 5. ИСТОРИЯ ГРУПП
INSERT INTO group_history (student_id, group_id, academic_year, semester, course) VALUES
(16, 16, '2020/2021', 1, 1),
(16, 16, '2020/2021', 2, 1),
(16, 18, '2021/2022', 1, 2),
(16, 18, '2021/2022', 2, 2),
(16, 19, '2022/2023', 1, 3),
(16, 19, '2022/2023', 2, 3),
(16, 20, '2023/2024', 1, 4),
(16, 20, '2023/2024', 2, 4),

(17, 16, '2020/2021', 1, 1),
(17, 16, '2020/2021', 2, 1),
(17, 18, '2021/2022', 1, 2),
(17, 18, '2021/2022', 2, 2),
(17, 19, '2022/2023', 1, 3),
(17, 19, '2022/2023', 2, 3),
(17, 20, '2023/2024', 1, 4),
(17, 20, '2023/2024', 2, 4),

(11, 16, '2021/2022', 1, 1),
(11, 16, '2021/2022', 2, 1),
(11, 18, '2022/2023', 1, 2),
(11, 18, '2022/2023', 2, 2),
(11, 19, '2023/2024', 1, 3),
(11, 19, '2023/2024', 2, 3),

(12, 16, '2021/2022', 1, 1),
(12, 16, '2021/2022', 2, 1),
(12, 18, '2022/2023', 1, 2),
(12, 18, '2022/2023', 2, 2),
(12, 19, '2023/2024', 1, 3),
(12, 19, '2023/2024', 2, 3),

(6, 1, '2022/2023', 1, 1),
(6, 1, '2022/2023', 2, 1),
(6, 18, '2023/2024', 1, 2),
(6, 18, '2023/2024', 2, 2),

(7, 1, '2022/2023', 1, 1),
(7, 1, '2022/2023', 2, 1),
(7, 18, '2023/2024', 1, 2),
(7, 18, '2023/2024', 2, 2),

(1, 3, '2023/2024', 1, 1),
(1, 3, '2023/2024', 2, 1),
(2, 3, '2023/2024', 1, 1),
(2, 3, '2023/2024', 2, 1);

-- 6. ЭКЗАМЕНЫ (для 4 курса за прошлые годы)
INSERT INTO exams (subject_id, group_id, teacher_name, exam_date, academic_year, semester) VALUES
(14, 20, 'Профессор Иванова М.П.', '2024-01-15', '2023/2024', 1),
(15, 20, 'Доцент Петров С.А.', '2024-01-20', '2023/2024', 1),
(16, 20, 'Профессор Сидоров А.В.', '2024-01-25', '2023/2024', 1),

-- 3 курс, 1 семестр 2022/2023
(11, 19, 'Доцент Кузнецова О.И.', '2023-01-10', '2022/2023', 1),
(12, 19, 'Профессор Васильев П.М.', '2023-01-15', '2022/2023', 1),
(13, 19, 'Доцент Николаева Е.С.', '2023-01-20', '2022/2023', 1),

-- 2 курс, 1 семестр 2021/2022
(7, 18, 'Доцент Федоров И.К.', '2022-01-12', '2021/2022', 1),
(8, 18, 'Профессор Михайлов А.Б.', '2022-01-18', '2021/2022', 1),
(9, 18, 'Доцент Егорова Т.В.', '2022-01-22', '2021/2022', 1),

-- 1 курс, 1 семестр 2020/2021
(1, 16, 'Профессор Соколов В.Г.', '2021-01-10', '2020/2021', 1),
(2, 16, 'Доцент Орлова Н.М.', '2021-01-15', '2020/2021', 1),
(5, 16, 'Доцент Жуков А.С.', '2021-01-20', '2020/2021', 1);

-- 7. РЕЗУЛЬТАТЫ ЭКЗАМЕНОВ
INSERT INTO exam_results (exam_id, student_id, grade, passed_at) VALUES

(1, 16, 5, '2024-01-15'),
(2, 16, 4, '2024-01-20'),
(3, 16, 5, '2024-01-25'),
(4, 16, 5, '2023-01-10'),
(5, 16, 4, '2023-01-15'),
(6, 16, 5, '2023-01-20'),
(7, 16, 5, '2022-01-12'),
(8, 16, 5, '2022-01-18'),
(9, 16, 4, '2022-01-22'),
(10, 16, 5, '2021-01-10'),
(11, 16, 5, '2021-01-15'),
(12, 16, 5, '2021-01-20'),

(1, 17, 5, '2024-01-15'),
(2, 17, 5, '2024-01-20'),
(3, 17, 5, '2024-01-25'),
(4, 17, 5, '2023-01-10'),
(5, 17, 5, '2023-01-15'),
(6, 17, 5, '2023-01-20'),
(7, 17, 5, '2022-01-12'),
(8, 17, 5, '2022-01-18'),
(9, 17, 5, '2022-01-22'),
(10, 17, 5, '2021-01-10'),
(11, 17, 5, '2021-01-15'),
(12, 17, 5, '2021-01-20'),

(4, 11, 4, '2023-01-10'),
(5, 11, 4, '2023-01-15'),
(6, 11, 4, '2023-01-20'),
(7, 11, 3, '2022-01-12'),
(8, 11, 4, '2022-01-18'),
(9, 11, 4, '2022-01-22'),

(10, 1, 4, '2021-01-10'),
(11, 1, 3, '2021-01-15'),
(12, 1, 4, '2021-01-20');

-- 8. ЗАЧЁТЫ
INSERT INTO tests (student_id, subject_id, academic_year, semester, is_passed, passed_at) VALUES
(16, 21, '2020/2021', 1, 1, '2020-12-15'),
(16, 21, '2020/2021', 2, 1, '2021-05-20'),
(16, 21, '2021/2022', 1, 1, '2021-12-10'),
(16, 21, '2021/2022', 2, 1, '2022-05-15'),
(16, 21, '2022/2023', 1, 1, '2022-12-12'),
(16, 21, '2022/2023', 2, 1, '2023-05-18'),
(16, 21, '2023/2024', 1, 1, '2023-12-14'),

(17, 21, '2020/2021', 1, 1, '2020-12-15'),
(17, 21, '2020/2021', 2, 1, '2021-05-20'),
(17, 21, '2021/2022', 1, 1, '2021-12-10'),
(17, 21, '2021/2022', 2, 1, '2022-05-15'),
(17, 21, '2022/2023', 1, 1, '2022-12-12'),
(17, 21, '2022/2023', 2, 1, '2023-05-18'),
(17, 21, '2023/2024', 1, 1, '2023-12-14'),

(11, 19, '2021/2022', 1, 1, '2021-12-15'),
(11, 19, '2021/2022', 2, 0, NULL),
(11, 19, '2021/2022', 2, 1, '2022-06-10'),
(11, 19, '2022/2023', 1, 1, '2022-12-18'),
(11, 19, '2022/2023', 2, 1, '2023-05-22'),

(1, 17, '2020/2021', 1, 1, '2020-12-20'),
(1, 18, '2020/2021', 2, 1, '2021-05-25'),
(6, 17, '2021/2022', 1, 1, '2021-12-22'),
(6, 18, '2021/2022', 2, 1, '2022-05-28');
